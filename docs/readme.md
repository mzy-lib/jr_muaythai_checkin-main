# JR泰拳馆签到系统

## 目录
1. [项目概述](#项目概述)
2. [核心功能](#核心功能)
3. [数据结构](#数据结构)
4. [业务流程](#业务流程)
5. [系统规则](#系统规则)


---

## 项目概述
JR泰拳馆签到系统是一个用于管理会员签到的 Web 应用，旨在简化会员签到流程、提升管理效率，并为管理员提供数据统计和分析功能。

### 核心目标
1. **会员签到管理**：支持新老会员签到，自动处理会员卡类型和签到规则。
2. **会员信息管理**：记录会员的基本信息、会员卡类型及状态。
3. **数据统计与分析**：为管理员提供签到记录查询和数据分析功能。

### 技术栈
- **前端**：React + TypeScript
- **后端**：Supabase（基于 PostgreSQL）
- **数据库**：PostgreSQL
- **开发工具**：Docker（用于本地开发环境）

### 环境要求
- Node.js >= 18
- npm >= 9
- Docker（用于本地开发）

---
## 核心功能
1. **签到管理**
   - 新会员签到（自动建档）
   - 老会员签到（身份验证）
   - 额外签到处理

2. **会员管理**
   - 会员信息记录
   - 会员卡状态跟踪
   - 签到记录查询

3. **数据统计**
   - 会员签到统计
   - 私教课时统计
   - 额外签到跟进

## 业务流程

### 1. 统一签到流程
```mermaid
graph TD
    A[会员到场] --> B[输入姓名和邮箱]
    B --> C{查找会员}
    C -->|未找到| D[创建新会员]
    C -->|已存在| E[验证身份]
    D --> F[额外签到]
    E --> G{选择课程类型}
    G -->|团课| H{检查团课卡}
    G -->|私教| I{检查私教卡}
    H -->|有效| J[团课签到]
    H -->|无效| F
    I -->|有效| K[私教签到]
    I -->|无效| F
```

### 2. 实际场景示例

#### 场景一：新会员首次签到
1. 输入姓名和邮箱
2. 系统自动创建会员档案
3. 记录额外签到
4. 工作人员跟进办卡

#### 场景二：老会员正常签到
1. 输入姓名和邮箱
2. 系统验证身份
3. 选择课程类型
4. 检查会员卡并签到

#### 场景三：老会员额外签到
1. 输入姓名和邮箱
2. 系统验证身份
3. 发现会员卡过期/课时用完/超出限制/无有效会员卡
4. 记录额外签到并提醒

## 数据统计功能
### 1. 签到统计
- 日/周/月签到人数
- 团课/私教课签到比例
- 额外签到跟踪记录

### 2. 私教课时统计
- 教练课时统计
- 1对1/1对2课程统计
---

## 数据结构

### 1. 会员信息 (members表)
- **会员ID**：唯一标识
- **会员姓名或微信名**：用于身份识别
- **联系方式（email）**：用于重名时的二次验证
- **最后签到日期**：记录最近一次签到日期

### 2. 会员卡信息 (membership_cards表)
- **id**: 卡ID
- **member_id**: 关联的会员ID
- **card_type**: 课程类型
  - 团课
  - 私教课
- **card_category**: 卡种类（仅团课适用）
  - 课时卡
  - 月卡
- **card_subtype**: 具体类型
  - 团课课时卡：单次卡、两次卡、10次卡
  - 团课月卡：单次月卡（每天最多1次）、双次月卡（每天最多2次）
  - 私教课：单次卡、10次卡
- **trainer_type**: 教练等级（仅私教课适用）
  - JR教练
  - 高级教练
- **remaining_group_sessions**: 剩余团课课时数（仅团课课时卡适用）
- **remaining_private_sessions**: 剩余私教课时数（仅私教课适用）
- **valid_until**: 有效期
：视情况而定，管理员手动输入

### 3. 签到记录 (check_ins表)
- **id**: 签到ID
- **member_id**: 会员ID
- **card_id**: 使用的会员卡ID
- **course_type**: 课程类型（团课/私教）
- **class_time**: 上课时段
  - 团课：早课（9:00-10:30）或晚课（17:00-18:30）
  - 私教：按具体预约时段
- **trainer_id**: 教练ID（仅私教课适用）
- **is_1v2**: 是否1对2私教课（仅私教课适用）
- **created_at**: 签到时间戳
- **check_in_date**: 签到日期
- **check_in_type**: 签到类型（正常/额外）

### 4. 教练信息 (trainer表)
- **id**: 教练ID
- **name**: 教练姓名
- **type**: 教练等级
  - JR教练：
  - 高级教练：
- **notes**: 备注信息

### 5. 教练课时统计规则
- **统计数据来源**：
  - 从check_ins表筛选私教课记录
  - 关联trainer表获取教练等级
- **统计维度**：
  - 按教练统计
  - 按月份统计
  - 按课程类型（1对1/1对2）统计
- **课时费计算**：（暂不计算）
  - 根据教练等级和课程类型自动计算
  - 支持自定义时间段统计
- **报表功能**：
  - 月度课时统计
  - 课时费用统计（暂不计算）
  - 自定义时段统计

---

## 系统规则

### 1. 私教课程规则
- **课时规则**：
  - 单次课：无时效限制
  - 10次课：有效期由管理员自定义
- **授课方式**：
  - 支持1对1和1对2授课
  - 1对2授课需线下额外收费


### 2. 团课规则

#### 成人团课课时卡
- **单次卡**：1次课时，无时效限制
- **两次卡**：2次课时，无时效限制
- **10次卡**：10次课时，有效期由管理员自定义

#### 成人团课月卡
- **单次月卡**：每天最多上1次课，购买日起30天内有效
- **双次月卡**：每天最多上2次课，购买日起30天内有效

### 3. 儿童团课规则
- **课时卡**：
  - 10次卡：10次课时，有效期由管理员自定义
- **签到规则**：
  - 每次签到扣除1次课时
  - 支持重复签到，每次都会扣除课时
  - 无月卡选项


### 3. 上课时段

#### 成人团课时段
- **早课**：9:00-10:30
- **晚课**：17:00-18:30
- **上课日**：周一至周六

#### 儿童团课时段
- **周六**：10:30-12:00

#### 私教时段
- **工作日（周一至周五）**
  - 早课：7:00-8:00, 8:00-9:00, 10:30-11:30
  - 下午：14:00-15:00, 15:00-16:00, 16:00-17:00
  - 晚课：18:30-19:30
- **周六**
    早课：7:00-8:00, 8:00-9:00
  - 下午：14:00-15:00, 15:00-16:00, 16:00-17:00
  - 晚课：18:30-19:30

### 4. 会员卡管理
- **多卡并存规则**：
  - 会员可同时持有多张不同类型的会员卡
  - 不同类型的课程使用对应类型的会员卡
  - 系统自动匹配对应类型的有效会员卡
- **课时扣除规则**：
  - 成人团课课时卡：每次签到扣除1次课时
  - 成人团课月卡：不扣除课时，按每日次数限制
  - 儿童团课课时卡：每次签到扣除1次课时
  - 私教课时卡：每次签到扣除1次课时（1对1/1对2均同）

### 5. 签到规则
- **基本规则**：
  - 身份验证：姓名/微信名+邮箱
  - 提前签到：支持当天任意时间签到
  - 重复限制：同一时段允许重复签到（考虑到共用同一张课时卡的情况），并重复扣除课时数
- **额外签到规则**：
  - **适用情况**：
    1. 新会员首次签到
       - 系统自动创建会员档案
       - 标记为新会员额外签到
       - 提醒工作人员跟进办卡
    
    2. 老会员无有效会员卡
       - 会员卡已过期
       - 课时已用完
       - 提醒续卡或购买新卡
    
    3. 老会员超出限制
       - 月卡超出每日上课次数
       - 提醒升级双次卡或补充课时卡

  - **处理方式**：
    - 允许签到但标记为"额外签到"
    - 系统记录完整签到信息
    - 不扣除任何课时
    - 用于课程出勤统计

### 6. 教练分类
- JR类教练1名：JR
- Senior类教练：Da, Ming, Big, Bas, Sumay, First. 

---

## 界面设计

### 1. 视觉风格
- **主色调**：泰拳传统红蓝色。
- **设计风格**：蒙德里安风格，简约大气。
- **元素设计**：添加泰拳元素（如拳套 emoji），避免无意义装饰。

### 2. 交互设计
- **多语言支持**：主页中英双语对照。
- **友好提示**：清晰的错误提示和操作反馈。
- **简洁流程**：减少操作步骤，提升用户体验。

## 函数文档

### 签到处理函数

#### handle_check_in
```sql
handle_check_in(
  p_member_id UUID,       -- 会员ID
  p_name TEXT,            -- 会员姓名
  p_email TEXT,           -- 会员邮箱
  p_class_type TEXT,      -- 课程类型（morning/evening/private）
  p_check_in_date DATE,   -- 签到日期
  p_card_id UUID,         -- 会员卡ID（可为NULL）
  p_trainer_id UUID,      -- 教练ID（私教课必填）
  p_is_1v2 BOOLEAN,       -- 是否为1对2私教课
  p_time_slot TEXT        -- 上课时段
) RETURNS JSONB
```

**功能说明**：
处理会员签到流程，包括新会员自动建档、老会员签到验证、会员卡有效性检查、签到记录创建等。

**参数说明**：
- `p_member_id`: 会员的唯一标识符
- `p_name`: 会员姓名，用于显示和识别
- `p_email`: 会员邮箱，用于身份验证和通知
- `p_class_type`: 课程类型，可选值为'morning'（早课）、'evening'（晚课）或'private'（私教课）
- `p_check_in_date`: 签到日期，通常为当天日期
- `p_card_id`: 会员卡ID，如果会员没有卡或不使用卡签到，可为NULL
- `p_trainer_id`: 教练ID，仅私教课需要指定
- `p_is_1v2`: 是否为1对2私教课，仅私教课适用
- `p_time_slot`: 上课时段，例如'9:00-10:30'（早课）、'17:00-18:30'（晚课）或私教具体时段

**返回值**：
返回一个JSON对象，包含以下字段：
- `success`: 布尔值，表示签到是否成功
- `message`: 文本消息，说明签到结果
- `isExtra`: 布尔值，表示是否为额外签到
- `checkInId`: 签到记录的唯一标识符（仅在签到成功时返回）
- `isDuplicate`: 布尔值，表示是否为重复签到（仅在重复签到时返回）
- `error`: 错误信息（仅在签到失败时返回）

**处理流程**：
1. 验证课程类型是否有效
2. 检查会员是否存在，不存在则创建新会员
3. 检查是否重复签到
4. 验证会员卡有效性（如果提供了会员卡ID）
5. 创建签到记录
6. 更新会员信息（额外签到次数和最后签到日期）
7. 返回签到结果

### 会员卡验证函数

#### check_card_validity
```sql
check_card_validity(
  p_card_id UUID,        -- 会员卡ID
  p_member_id UUID,      -- 会员ID
  p_class_type TEXT,     -- 课程类型
  p_check_in_date DATE   -- 签到日期
) RETURNS BOOLEAN
```

**功能说明**：
检查会员卡是否有效，包括会员卡所有权验证、类型匹配检查、有效期检查和剩余课时检查。

**参数说明**：
- `p_card_id`: 会员卡的唯一标识符
- `p_member_id`: 会员的唯一标识符
- `p_class_type`: 课程类型，用于检查会员卡类型是否匹配
- `p_check_in_date`: 签到日期，用于检查会员卡是否在有效期内

**返回值**：
返回一个布尔值，表示会员卡是否有效：
- `TRUE`: 会员卡有效
- `FALSE`: 会员卡无效

**验证规则**：
1. 检查会员卡是否存在
2. 检查会员卡是否属于指定会员
3. 检查会员卡类型是否匹配课程类型
4. 检查会员卡是否在有效期内
5. 检查会员卡是否有足够的剩余课时

### 其他辅助函数

#### check_member_exists
```sql
check_member_exists(p_member_id UUID) RETURNS BOOLEAN
```


#### check_monthly_card_daily_limit
```sql
check_monthly_card_daily_limit(
  p_member_id UUID,
  p_card_id UUID,
  p_check_in_date DATE
) RETURNS BOOLEAN
```

**功能说明**：
检查会员的月卡在指定日期是否已达到每日签到次数限制。

--By Hongyi Ji hongyiji224@gmail.com