# 数据库优化迁移说明

本目录包含了一系列数据库优化迁移文件，旨在提高系统的稳定性和性能。

## 迁移内容

1. **01_split_validation_logic.sql**：拆分验证逻辑，创建辅助验证函数
2. **02_optimize_validate_check_in.sql**：优化签到验证函数，简化条件判断
3. **03_separate_session_deduction.sql**：分离课时扣除逻辑，优化处理签到函数
4. **04_add_performance_indexes.sql**：添加性能优化索引
5. **05_add_transaction_management.sql**：添加事务管理优化
6. **06_add_card_validity_management.sql**：添加会员卡有效期管理

## 应用迁移

要应用所有迁移，请执行以下命令：

```bash
cd migrations
./run_migrations.sh
```

脚本会自动检查数据库连接，创建迁移表，并按顺序应用所有未应用的迁移。

## 回滚迁移

如果需要回滚最后一次迁移，请执行以下命令：

```bash
cd migrations
./rollback_migrations.sh
```

脚本会提示您确认是否回滚最后一次迁移。

## 注意事项

1. 确保已正确设置环境变量（`.env`文件）
2. 迁移前建议备份数据库
3. 迁移过程中可能会短暂影响系统性能，建议在低峰期执行

## 优化效果

这些迁移将带来以下优化效果：

1. **性能提升**：
   - 优化锁策略，减少锁竞争
   - 添加索引，提高查询性能
   - 简化条件判断，减少执行时间

2. **稳定性提升**：
   - 使用事务管理，确保数据一致性
   - 分离业务逻辑，减少复杂度
   - 优化错误处理，提高系统健壮性

3. **可维护性提升**：
   - 拆分复杂函数，提高代码可读性
   - 统一业务逻辑，减少重复代码
   - 添加详细注释，便于后续维护 